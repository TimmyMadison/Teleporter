-- COMPLETE TELEPORTER SCRIPT BY KRYSAN (No Animation Tab)

local Players = game:GetService("Players")
local lp = Players.LocalPlayer

shared._combatSettings = shared._combatSettings or {
    teleportOn = false,
    teamCheck = false,
    ragdollCheck = false,
    lockTarget = false,
    friendCheck = false,
    dodge = false,
    oneTimeKill = false,
    lowestHealth = false,
    teleportDistance = 4,
    teleportUp = 2,
    targetName = "",
}
shared._combatGuiRefs = {}

-- PASSIVE ANIMATION DETECTION (No GUI)
shared._animationDetection = {
    enabled = true,
    animationIds = {13927612951},
    highlightDuration = 5,
    highlightColor = Color3.fromRGB(255, 165, 0),
    highlightOutline = Color3.fromRGB(200, 130, 0),
    activeHighlights = {}
}

-- GUI CREATION
local gui = Instance.new("ScreenGui", game.CoreGui)
gui.Name = "CombatGUI"
gui.ResetOnSpawn = false

local wrapper = Instance.new("Frame", gui)
wrapper.Size = UDim2.new(0, 320, 0, 450)
wrapper.Position = UDim2.new(0.3, 0, 0.2, 0)
wrapper.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
wrapper.BorderSizePixel = 0
wrapper.Active = true
wrapper.Draggable = true
Instance.new("UICorner", wrapper).CornerRadius = UDim.new(0, 10)
Instance.new("UIStroke", wrapper).Color = Color3.fromRGB(60, 60, 60)

local titleBar = Instance.new("Frame", wrapper)
titleBar.Size = UDim2.new(1, 0, 0, 30)
titleBar.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
titleBar.BorderSizePixel = 0
Instance.new("UICorner", titleBar).CornerRadius = UDim.new(0, 10)

local title = Instance.new("TextLabel", titleBar)
title.Size = UDim2.new(1, -40, 1, 0)
title.Position = UDim2.new(0, 10, 0, 0)
title.Text = "Teleporter by Krysan"
title.TextColor3 = Color3.new(1, 1, 1)
title.BackgroundTransparency = 1
title.TextXAlignment = Enum.TextXAlignment.Left
title.TextScaled = true

local tabBar = Instance.new("Frame", wrapper)
tabBar.Size = UDim2.new(1, 0, 0, 40)
tabBar.Position = UDim2.new(0, 0, 0, 30)
tabBar.BackgroundColor3 = Color3.fromRGB(35, 35, 35)

local contentFrame = Instance.new("Frame", wrapper)
contentFrame.Size = UDim2.new(1, 0, 1, -70)
contentFrame.Position = UDim2.new(0, 0, 0, 70)
contentFrame.BackgroundTransparency = 1

local Tabs = {}
local tabCount = 0
local function createTab(name)
    local tab = Instance.new("Frame")
    tab.Size = UDim2.new(1, 0, 1, 0)
    tab.BackgroundTransparency = 1
    tab.Visible = false
    tab.Parent = contentFrame

    local layout = Instance.new("UIListLayout", tab)  
    layout.Padding = UDim.new(0, 8)  
    layout.SortOrder = Enum.SortOrder.LayoutOrder  
    layout.HorizontalAlignment = Enum.HorizontalAlignment.Center  

    Tabs[name] = tab  

    local btn = Instance.new("TextButton")  
    btn.Size = UDim2.new(0.5, -10, 1, -8)  
    btn.Position = UDim2.new(tabCount * 0.5, 5, 0, 4)  
    btn.Text = name  
    btn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)  
    btn.TextColor3 = Color3.new(1, 1, 1)  
    btn.TextScaled = true  
    btn.Parent = tabBar  
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)  

    btn.MouseButton1Click:Connect(function()  
        for _, t in pairs(Tabs) do t.Visible = false end  
        tab.Visible = true  
    end)  

    tabCount += 1  
    return tab
end

-- ONLY Main and Settings tabs (NO Animation tab)
local mainTab = createTab("Main")
local settingsTab = createTab("Settings")
mainTab.Visible = true

local function createButton(tab, label, color)
    local btn = Instance.new("TextButton", tab)
    btn.Size = UDim2.new(1, -20, 0, 35)
    btn.Text = label
    btn.BackgroundColor3 = color or Color3.fromRGB(60, 60, 60)
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.TextScaled = true
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)
    Instance.new("UIStroke", btn).Color = Color3.fromRGB(80, 80, 80)
    return btn
end

local toggleButtons = {}

local function createToggle(tab, label, key)
    local btn = createButton(tab, label .. ": Off", Color3.fromRGB(60, 60, 60))
    
    toggleButtons[key] = {btn = btn, label = label}
    
    btn.MouseButton1Click:Connect(function()
        shared._combatSettings[key] = not shared._combatSettings[key]
        btn.Text = label .. ": " .. (shared._combatSettings[key] and "On" or "Off")
        btn.BackgroundColor3 = shared._combatSettings[key] and Color3.fromRGB(80, 120, 80) or Color3.fromRGB(60, 60, 60)
    end)
    return btn
end

local function initializeToggleButtons()
    for key, data in pairs(toggleButtons) do
        local currentState = shared._combatSettings[key]
        data.btn.Text = data.label .. ": " .. (currentState and "On" or "Off")
        data.btn.BackgroundColor3 = currentState and Color3.fromRGB(80, 120, 80) or Color3.fromRGB(60, 60, 60)
    end
end

local teleportBtn = createButton(mainTab, "Teleport: Off", Color3.fromRGB(70, 70, 70))
shared._combatGuiRefs.teleportButton = teleportBtn

local safePlatformBtn = createButton(mainTab, "Teleport to Platform", Color3.fromRGB(80, 120, 200))
local safePlatformCreated = false
local safePlatformPart = nil
local platformPos = Vector3.new(0, -494.5, 0)

safePlatformBtn.MouseButton1Click:Connect(function()
    if not safePlatformCreated then
        safePlatformPart = Instance.new("Part")
        safePlatformPart.Name = "SafePlatform_Lio"
        safePlatformPart.Size = Vector3.new(1000, 2, 1000)
        safePlatformPart.Position = Vector3.new(0, -500, 0)
        safePlatformPart.Anchored = true
        safePlatformPart.CanCollide = true
        safePlatformPart.Transparency = 0.5
        safePlatformPart.Color = Color3.fromRGB(0, 170, 255)
        safePlatformPart.Parent = workspace
        
        safePlatformCreated = true
        safePlatformBtn.Text = "Platform Created"
        safePlatformBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
        
        task.wait(2)
        safePlatformBtn.Text = "Teleport to Platform"
        safePlatformBtn.BackgroundColor3 = Color3.fromRGB(80, 120, 200)
        return
    end
    
    if shared._combatSettings.teleportOn then
        shared._combatSettings.teleportOn = false
        teleportBtn.Text = "Teleport: Off"
        teleportBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    end
    
    task.wait(0.1)
    
    local char = lp.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        if char.PrimaryPart == nil then
            char.PrimaryPart = char.HumanoidRootPart
        end
        
        safePlatformBtn.Text = "Fixing Camera..."
        safePlatformBtn.BackgroundColor3 = Color3.fromRGB(200, 100, 0)
        
        local cameraFixed, reason = fixCameraCompletely()
        
        char:SetPrimaryPartCFrame(CFrame.new(platformPos))
        
        task.wait(0.3)
        local cameraFixedAfter, reasonAfter = fixCameraCompletely()
        
        if cameraFixed or cameraFixedAfter then
            safePlatformBtn.Text = "Fixed Camera & Teleported!"
            safePlatformBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
        else
            safePlatformBtn.Text = "Teleported (Camera Issue)"
            safePlatformBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 0)
        end
    else
        safePlatformBtn.Text = "No Character!"
        safePlatformBtn.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
    end
    
    task.wait(2)
    safePlatformBtn.Text = "Teleport to Platform"
    safePlatformBtn.BackgroundColor3 = Color3.fromRGB(80, 120, 200)
end)

local goToFriendBtn = createButton(mainTab, "Go to Friend", Color3.fromRGB(80, 120, 200))
local currentFriendIndex = 0
local friendList = {}

local function updateFriendList()
    friendList = {}
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= lp and lp:IsFriendsWith(player.UserId) then
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
                if humanoid and humanoid.Health > 0 then
                    table.insert(friendList, player)
                end
            end
        end
    end
end

goToFriendBtn.MouseButton1Click:Connect(function()
    if shared._combatSettings.teleportOn then
        shared._combatSettings.teleportOn = false
        teleportBtn.Text = "Teleport: Off"
        teleportBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    end
    
    updateFriendList()
    
    if #friendList == 0 then
        goToFriendBtn.Text = "No Friends Online!"
        goToFriendBtn.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
        task.wait(2)
        goToFriendBtn.Text = "Go to Friend"
        goToFriendBtn.BackgroundColor3 = Color3.fromRGB(80, 120, 200)
        return
    end
    
    currentFriendIndex = (currentFriendIndex % #friendList) + 1
    local selectedFriend = friendList[currentFriendIndex]
    
    task.wait(0.1)
    
    local char = lp.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        if char.PrimaryPart == nil then
            char.PrimaryPart = char.HumanoidRootPart
        end
        
        local cameraWasFixed, reason = fixCameraCompletely()
        
        local friendPos = selectedFriend.Character.HumanoidRootPart.Position
        local offset = Vector3.new(0, 3, 0)
        local targetPos = friendPos + offset
        
        char:SetPrimaryPartCFrame(CFrame.new(targetPos))
        
        task.wait(0.2)
        local cameraFixedAfter, reasonAfter = fixCameraCompletely()
        
        goToFriendBtn.Text = "Teleported to " .. selectedFriend.Name .. " (" .. currentFriendIndex .. "/" .. #friendList .. ")"
        goToFriendBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
    else
        goToFriendBtn.Text = "No Character!"
        goToFriendBtn.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
    end
    
    task.wait(3)
    goToFriendBtn.Text = "Go to Friend"
    goToFriendBtn.BackgroundColor3 = Color3.fromRGB(80, 120, 200)
end)

local resetBtn = createButton(mainTab, "Reset Character", Color3.fromRGB(150, 50, 50))
resetBtn.MouseButton1Click:Connect(function()
    local hum = lp.Character and lp.Character:FindFirstChildOfClass("Humanoid")
    if hum then hum.Health = 0 end
end)

local targeterBox = Instance.new("TextBox", mainTab)
targeterBox.Size = UDim2.new(1, -20, 0, 35)
targeterBox.Text = ""
targeterBox.PlaceholderText = "Targeter (Username or DisplayName)"
targeterBox.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
targeterBox.TextColor3 = Color3.new(1, 1, 1)
targeterBox.PlaceholderColor3 = Color3.fromRGB(180, 180, 180)
targeterBox.TextScaled = true
targeterBox.ClearTextOnFocus = false
Instance.new("UICorner", targeterBox).CornerRadius = UDim.new(0, 6)
Instance.new("UIStroke", targeterBox).Color = Color3.fromRGB(100, 100, 100)
targeterBox.FocusLost:Connect(function()
    shared._combatSettings.targetName = targeterBox.Text
end)

-- Ignore list input (ADDED BACK)
shared._combatSettings.ignoreNames = shared._combatSettings.ignoreNames or {}
local ignoredNames = shared._combatSettings.ignoreNames

local ignoreInput = Instance.new("TextBox", mainTab)
ignoreInput.Size = UDim2.new(1, -20, 0, 35)
ignoreInput.PlaceholderText = "Enter name to ignore"
ignoreInput.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
ignoreInput.TextColor3 = Color3.new(1, 1, 1)
ignoreInput.PlaceholderColor3 = Color3.fromRGB(180, 180, 180)
ignoreInput.TextScaled = true
Instance.new("UICorner", ignoreInput).CornerRadius = UDim.new(0, 6)
Instance.new("UIStroke", ignoreInput).Color = Color3.fromRGB(80, 80, 80)

local ignoreListFrame = Instance.new("Frame", mainTab)
ignoreListFrame.Size = UDim2.new(1, -20, 0, 100)
ignoreListFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
Instance.new("UICorner", ignoreListFrame).CornerRadius = UDim.new(0, 6)
Instance.new("UIStroke", ignoreListFrame).Color = Color3.fromRGB(60, 60, 60)
local listLayout = Instance.new("UIListLayout", ignoreListFrame)
listLayout.SortOrder = Enum.SortOrder.LayoutOrder
listLayout.Padding = UDim.new(0, 3)

local function updateIgnoreUI()
    for _, child in ipairs(ignoreListFrame:GetChildren()) do
        if child:IsA("TextButton") then child:Destroy() end
    end
    for _, name in ipairs(ignoredNames) do
        local btn = createButton(ignoreListFrame, name, Color3.fromRGB(80, 40, 40))
        btn.Size = UDim2.new(1, -10, 0, 25)
        btn.TextScaled = true
        btn.MouseButton1Click:Connect(function()
            for i, v in ipairs(ignoredNames) do
                if v == name then
                    table.remove(ignoredNames, i)
                    updateIgnoreUI()
                    break
                end
            end
        end)
    end
end

ignoreInput.FocusLost:Connect(function()
    local name = ignoreInput.Text
    if name == "" then return end
    if not table.find(ignoredNames, name) then
        table.insert(ignoredNames, name)
        updateIgnoreUI()
    end
    ignoreInput.Text = ""
end)

Players.PlayerRemoving:Connect(function(player)
    for i = #ignoredNames, 1, -1 do
        if ignoredNames[i] == player.Name then
            table.remove(ignoredNames, i)
            updateIgnoreUI()
        end
    end
end)

-- Animation detect toggle MOVED HERE (after ignores input)
local animDetectBtn = createButton(mainTab, "Animation Detect: On", Color3.fromRGB(80, 120, 80))
animDetectBtn.MouseButton1Click:Connect(function()
    shared._animationDetection.enabled = not shared._animationDetection.enabled
    animDetectBtn.Text = "Animation Detect: " .. (shared._animationDetection.enabled and "On" or "Off")
    animDetectBtn.BackgroundColor3 = shared._animationDetection.enabled and Color3.fromRGB(80, 120, 80) or Color3.fromRGB(60, 60, 60)
    
    if not shared._animationDetection.enabled then
        for playerName, _ in pairs(shared._animationDetection.activeHighlights) do
            local player = Players:FindFirstChild(playerName)
            if player and player.Character then
                local hl = player.Character:FindFirstChild("ANIM_HL")
                if hl then hl:Destroy() end
            end
        end
        shared._animationDetection.activeHighlights = {}
    end
end)

local function isCameraStuck()
    local camera = workspace.CurrentCamera
    local player = game.Players.LocalPlayer
    local char = player.Character
    
    if camera.CameraSubject == nil or camera.CameraSubject.Parent == nil then
        return true, "No CameraSubject"
    end
    
    if not (camera.CameraSubject:IsA("Humanoid") and camera.CameraSubject.Parent == char) then
        return true, "Wrong CameraSubject"
    end
    
    if camera.CameraType == Enum.CameraType.Scriptable or camera.CameraType == Enum.CameraType.Fixed then
        return true, "Locked CameraType"
    end
    
    if camera.Parent ~= workspace then
        return true, "Wrong Parent"
    end
    
    return false, nil
end

local function fixCameraCompletely()
    local camera = workspace.CurrentCamera
    local player = game.Players.LocalPlayer
    
    local maxAttempts = 5
    local attempt = 0
    local fixed = false
    local lastReason = ""
    
    while attempt < maxAttempts do
        attempt += 1
        local stuck, reason = isCameraStuck()
        
        if not stuck then
            fixed = true
            break
        end
        
        lastReason = reason
        
        if attempt == 1 then
            camera.CameraType = Enum.CameraType.Custom
            camera.CFrame = CFrame.new()
            if player.Character and player.Character:FindFirstChild("Humanoid") then
                camera.CameraSubject = player.Character.Humanoid
            end
            task.wait(0.1)
            camera.CameraType = Enum.CameraType.Follow
        elseif attempt == 2 then
            camera.CameraType = Enum.CameraType.Custom
            task.wait(0.05)
            camera.CameraType = Enum.CameraType.Follow
            task.wait(0.05)
            camera.CameraType = Enum.CameraType.Custom
        elseif attempt == 3 then
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                camera.CFrame = CFrame.new(player.Character.HumanoidRootPart.Position + Vector3.new(0, 5, -10), player.Character.HumanoidRootPart.Position)
            end
            camera.CameraType = Enum.CameraType.Custom
        else
            camera.CameraType = Enum.CameraType.Custom
            camera.CameraSubject = nil
            task.wait(0.1)
            if player.Character and player.Character:FindFirstChild("Humanoid") then
                camera.CameraSubject = player.Character.Humanoid
                camera.CameraType = Enum.CameraType.Follow
            end
        end
        
        task.wait(0.1)
    end
    
    return fixed, lastReason
end

-- Settings tab toggles only
createToggle(settingsTab, "Team Check", "teamCheck")
createToggle(settingsTab, "Friend Check", "friendCheck")
createToggle(settingsTab, "Ragdoll Check", "ragdollCheck")
createToggle(settingsTab, "Dodge", "dodge")
createToggle(settingsTab, "Lock Target", "lockTarget")
createToggle(settingsTab, "One Time Kill", "oneTimeKill")
createToggle(settingsTab, "Lowest Health", "lowestHealth")

initializeToggleButtons()

local miniWrapper = Instance.new("Frame", gui)
miniWrapper.Size = UDim2.new(0, 240, 0, 45)
miniWrapper.Position = UDim2.new(0.65, 0, 0.2, 0)
miniWrapper.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
miniWrapper.BorderSizePixel = 0
miniWrapper.Active = true
miniWrapper.Draggable = true
Instance.new("UICorner", miniWrapper).CornerRadius = UDim.new(0, 8)
Instance.new("UIStroke", miniWrapper).Color = Color3.fromRGB(60, 60, 60)

shared._combatSettings.teleportDistance = shared._combatSettings.teleportDistance or 4
shared._combatSettings.teleportUp = shared._combatSettings.teleportUp or 2

local spotBtn = Instance.new("TextButton", miniWrapper)
spotBtn.Size = UDim2.new(1, -10, 1, -10)
spotBtn.Position = UDim2.new(0, 5, 0, 5)
spotBtn.Text = "Position: Risky"
spotBtn.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
spotBtn.TextColor3 = Color3.new(1, 1, 1)
spotBtn.TextScaled = true
Instance.new("UICorner", spotBtn).CornerRadius = UDim.new(0, 6)
Instance.new("UIStroke", spotBtn).Color = Color3.fromRGB(80, 80, 80)

local function toggleSpot()
    if spotBtn.Text == "Position: Risky" then
        shared._combatSettings.teleportDistance = 0
        shared._combatSettings.teleportUp = 30
        spotBtn.Text = "Position: Safe"
        spotBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
    else
        shared._combatSettings.teleportDistance = 4
        shared._combatSettings.teleportUp = 2
        spotBtn.Text = "Position: Risky"
        spotBtn.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
    end
end

spotBtn.MouseButton1Click:Connect(toggleSpot)

wrapper:GetPropertyChangedSignal("Visible"):Connect(function()
    miniWrapper.Visible = wrapper.Visible
end)
miniWrapper.Visible = wrapper.Visible

local closeBtn = Instance.new("TextButton", wrapper)
closeBtn.Size = UDim2.new(0, 25, 0, 25)
closeBtn.Position = UDim2.new(1, -30, 0, 2)
closeBtn.Text = "âœ–"
closeBtn.TextColor3 = Color3.new(1, 0.3, 0.3)
closeBtn.BackgroundColor3 = Color3.fromRGB(60, 0, 0)
closeBtn.TextScaled = true
Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0, 6)

local reopenBtn = Instance.new("TextButton", gui)
reopenBtn.Size = UDim2.new(0, 100, 0, 35)
reopenBtn.Position = UDim2.new(0, 10, 0, 10)
reopenBtn.Text = "Open GUI"
reopenBtn.BackgroundColor3 = Color3.fromRGB(0, 80, 0)
reopenBtn.TextColor3 = Color3.new(1, 1, 1)
reopenBtn.TextScaled = true
reopenBtn.Visible = false
Instance.new("UICorner", reopenBtn).CornerRadius = UDim.new(0, 6)
Instance.new("UIStroke", reopenBtn).Color = Color3.fromRGB(0, 120, 0)

closeBtn.MouseButton1Click:Connect(function()
    wrapper.Visible = false
    miniWrapper.Visible = false
    reopenBtn.Visible = true
end)

reopenBtn.MouseButton1Click:Connect(function()
    wrapper.Visible = true
    miniWrapper.Visible = true
    reopenBtn.Visible = false
end)

-- PASSIVE ANIMATION DETECTION SYSTEM (NO GUI)
local function createAnimationHighlight(player)
    if not player.Character then return end
    
    local hl = player.Character:FindFirstChild("ANIM_HL")
    if not hl then
        hl = Instance.new("Highlight")
        hl.Name = "ANIM_HL"
        hl.Parent = player.Character
        hl.FillTransparency = 0.3
        hl.OutlineTransparency = 0
        hl.FillColor = shared._animationDetection.highlightColor
        hl.OutlineColor = shared._animationDetection.highlightOutline
        hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    end
    
    return hl
end

local function removeAnimationHighlight(player)
    if player.Character then
        local hl = player.Character:FindFirstChild("ANIM_HL")
        if hl then hl:Destroy() end
    end
    shared._animationDetection.activeHighlights[player.Name] = nil
end

local function updateAnimationHighlights()
    if not shared._animationDetection.enabled then return end
    
    local currentTime = tick()
    
    for playerName, data in pairs(shared._animationDetection.activeHighlights) do
        if currentTime > data.endTime then
            local player = Players:FindFirstChild(playerName)
            if player then
                removeAnimationHighlight(player)
            else
                shared._animationDetection.activeHighlights[playerName] = nil
            end
        end
    end
    
    for playerName, data in pairs(shared._animationDetection.activeHighlights) do
        local player = Players:FindFirstChild(playerName)
        if player and player.Character then
            createAnimationHighlight(player)
        else
            shared._animationDetection.activeHighlights[playerName] = nil
        end
    end
end

local function monitorPlayerAnimations(player)
    local connection
    local lastAnimations = {}
    
    local function checkAnimations()
        if not player.Character then return end
        
        local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
        if not humanoid then return end
        
        local animator = humanoid:FindFirstChildOfClass("Animator")
        if not animator then return end
        
        for _, track in pairs(animator:GetPlayingAnimationTracks()) do
            local anim = track.Animation
            if anim then
                local animId = tonumber(anim.AnimationId:match("%d+"))
                if animId and table.find(shared._animationDetection.animationIds, animId) then
                    if not lastAnimations[animId] then
                        shared._animationDetection.activeHighlights[player.Name] = {
                            endTime = tick() + shared._animationDetection.highlightDuration,
                            animationId = animId
                        }
                        lastAnimations[animId] = true
                    end
                end
            end
        end
        
        for animId, _ in pairs(lastAnimations) do
            local found = false
            for _, track in pairs(animator:GetPlayingAnimationTracks()) do
                local anim = track.Animation
                if anim then
                    local currentAnimId = tonumber(anim.AnimationId:match("%d+"))
                    if currentAnimId == animId then
                        found = true
                        break
                    end
                end
            end
            
            if not found then
                lastAnimations[animId] = nil
            end
        end
    end
    
    connection = game:GetService("RunService").Heartbeat:Connect(checkAnimations)
    
    player:GetPropertyChangedSignal("Character"):Connect(function()
        removeAnimationHighlight(player)
        lastAnimations = {}
    end)
    
    player.AncestryChanged:Connect(function()
        if not player:IsDescendantOf(game) then
            if connection then
                connection:Disconnect()
            end
            removeAnimationHighlight(player)
            shared._animationDetection.activeHighlights[player.Name] = nil
        end
    end)
end

-- Initialize animation monitoring for all players
for _, player in ipairs(Players:GetPlayers()) do
    if player ~= lp then
        monitorPlayerAnimations(player)
    end
end

Players.PlayerAdded:Connect(function(player)
    task.wait(1)
    if player ~= lp then
        monitorPlayerAnimations(player)
    end
end)

-- COMBAT LOGIC
local RunService = game:GetService("RunService")

local friendCache = {}
local function updateFriendCache()
    friendCache = {}
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= lp and lp:IsFriendsWith(plr.UserId) then
            friendCache[plr.Name] = true
        end
    end
end

updateFriendCache()

Players.PlayerAdded:Connect(function(plr)
    task.wait(1)
    if lp:IsFriendsWith(plr.UserId) then
        friendCache[plr.Name] = true
    end
end)

Players.PlayerRemoving:Connect(function(plr)
    friendCache[plr.Name] = nil
end)

local function isValidTarget(plr)
    if plr then
        if plr == lp then return false end
        
        if shared._combatSettings.friendCheck and friendCache[plr.Name] then 
            return false 
        end
        
        if shared._combatSettings.teamCheck and plr.Team == lp.Team then 
            return false 
        end
        
        local targetName = shared._combatSettings.targetName or ""
        if targetName and #targetName > 0 then
            local nameMatch = plr.Name:lower():find(targetName:lower(), 1, true) or 
                             (plr.DisplayName and plr.DisplayName:lower():find(targetName:lower(), 1, true))
            if not nameMatch then
                return false
            end
        end
        
        if not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then 
            return false 
        end
        
        local hum = plr.Character:FindFirstChildOfClass("Humanoid")
        if not hum or hum.Health <= 0 then 
            return false 
        end

        local ignoreList = shared._combatSettings.ignoreNames or {}  
        for _, ignored in ipairs(ignoreList) do  
            local ignoredLower = ignored:lower()  
            if plr.Name:lower():find(ignoredLower, 1, true) or (plr.DisplayName and plr.DisplayName:lower():find(ignoredLower, 1, true)) then  
                return false  
            end  
        end  
        
        return true
    end
    return false
end

local function findNearestEnemy()
    local closest, dist = nil, math.huge
    local myPos = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart") and lp.Character.HumanoidRootPart.Position
    
    if not myPos then return nil end
    
    for _, plr in ipairs(Players:GetPlayers()) do
        if isValidTarget(plr) then
            local d = (myPos - plr.Character.HumanoidRootPart.Position).Magnitude
            if d < dist then
                closest = plr
                dist = d
            end
        end
    end
    
    return closest
end

local function findLowestHealthEnemy()
    local lowest, minHealth = nil, math.huge
    local myPos = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart") and lp.Character.HumanoidRootPart.Position
    
    if not myPos then return nil end
    
    for _, plr in ipairs(Players:GetPlayers()) do
        if isValidTarget(plr) then
            local hum = plr.Character:FindFirstChildOfClass("Humanoid")
            if hum and hum.Health < minHealth then
                lowest = plr
                minHealth = hum.Health
            end
        end
    end
    
    return lowest
end

local function findPlayerByName(name)
    name = name:lower()
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= lp then
            if plr.Name:lower():find(name,1,true) or (plr.DisplayName and plr.DisplayName:lower():find(name,1,true)) then
                return plr
            end
        end
    end
    return nil
end

local function hasValidTargets()
    for _, plr in ipairs(Players:GetPlayers()) do
        if isValidTarget(plr) then
            return true
        end
    end
    
    return false
end

local function moveEntireCharacter(char, targetCFrame)
    if char and char:FindFirstChild("HumanoidRootPart") then
        if char.PrimaryPart == nil then
            char.PrimaryPart = char.HumanoidRootPart
        end
        
        char:SetPrimaryPartCFrame(targetCFrame)
    end
end

local dodgeBoost = 50
local lastHealth = lp.Character and lp.Character:FindFirstChildOfClass("Humanoid") and lp.Character:FindFirstChildOfClass("Humanoid").Health or 100
local dodgePosition = nil
local dodgeTimer = 0
local originalDistance = shared._combatSettings.teleportDistance

local function onHealthChanged(newHealth)
    if not shared._combatSettings.dodge then return end
    if newHealth < lastHealth then
        local char = lp.Character
        if char and char:FindFirstChild("HumanoidRootPart") then
            if shared._combatSettings.teleportOn then
                dodgeTimer = 1.5
                shared._combatSettings.teleportDistance = originalDistance + dodgeBoost
            else
                local hrp = char.HumanoidRootPart
                dodgePosition = hrp.Position - hrp.CFrame.LookVector * dodgeBoost
                task.delay(1.5, function()
                    dodgePosition = nil
                end)
            end
        end
    end
    lastHealth = newHealth
end

lp.CharacterAdded:Connect(function(char)
    local hum = char:WaitForChild("Humanoid")
    lastHealth = hum.Health
    hum.HealthChanged:Connect(onHealthChanged)
end)

if lp.Character then
    local hum = lp.Character:FindFirstChildOfClass("Humanoid")
    if hum then
        lastHealth = hum.Health
        hum.HealthChanged:Connect(onHealthChanged)
    end
end

local function isRagdolled()
    local char = lp.Character
    if not char then return false end
    local hum = char:FindFirstChildOfClass("Humanoid")
    if hum then
        if hum:GetState() == Enum.HumanoidStateType.Physics then return true end
        if hum.PlatformStand then return true end
    end
    for _, v in pairs(char:GetChildren()) do
        if tostring(v.Name):lower():find("ragdoll") then return true end
    end
    return false
end

local currentTarget = nil
local trackedTarget = nil
local teleportBtn = shared._combatGuiRefs.teleportButton
local autoDisabled = false
local manualOff = false
local teleportStatusReason = nil

local function updateTeleportButton()
    if teleportStatusReason then
        teleportBtn.Text = "Teleport: Off ("..teleportStatusReason..")"
    else
        teleportBtn.Text = "Teleport: "..(shared._combatSettings.teleportOn and "On" or "Off")
    end
end

teleportBtn.MouseButton1Click:Connect(function()
    if teleportStatusReason then
        teleportStatusReason = nil
        updateTeleportButton()
        manualOff = true
    else
        shared._combatSettings.teleportOn = not shared._combatSettings.teleportOn
        manualOff = not shared._combatSettings.teleportOn
        teleportStatusReason = nil
        updateTeleportButton()
    end
    
    if not shared._combatSettings.teleportOn then
        currentTarget = nil
        trackedTarget = nil
    end
end)

lp.CharacterAdded:Connect(function()
    teleportStatusReason = nil
    manualOff = false
    updateTeleportButton()
    updateFriendCache()
end)

local function selectTarget()
    local targetName = shared._combatSettings.targetName
    
    if targetName and #targetName > 0 then
        return findPlayerByName(targetName)
    elseif shared._combatSettings.lowestHealth then
        return findLowestHealthEnemy()
    else
        return findNearestEnemy()
    end
end

local function checkNoTargets()
    if shared._combatSettings.teleportOn and not manualOff then
        if not hasValidTargets() then
            if teleportStatusReason ~= "No Target" then
                teleportStatusReason = "No Target"
                updateTeleportButton()
            end
            return true
        end
    end
    return false
end

-- MAIN LOOP
RunService.Heartbeat:Connect(function()
    updateAnimationHighlights()
    
    if dodgeTimer > 0 then
        dodgeTimer = math.max(0, dodgeTimer - RunService.Heartbeat:Wait())
        if dodgeTimer == 0 then
            shared._combatSettings.teleportDistance = originalDistance
        end
    end

    local char = lp.Character  
    local hum = char and char:FindFirstChildOfClass("Humanoid")  
    local dead = not char or not hum or hum.Health <= 0 or not char:FindFirstChild("HumanoidRootPart")  
    local ragdoll = isRagdolled()  

    if shared._combatSettings.teleportOn and not manualOff then  
        if dead then  
            shared._combatSettings.teleportOn = false  
            autoDisabled = true  
            teleportStatusReason = "Dead"  
            updateTeleportButton()  
            return  
        elseif ragdoll and shared._combatSettings.ragdollCheck then  
            shared._combatSettings.teleportOn = false  
            autoDisabled = true  
            teleportStatusReason = "Ragdolled"  
            updateTeleportButton()  
            return  
        end  
    end  

    if autoDisabled and not ragdoll and not dead and not manualOff then  
        if teleportStatusReason then
            teleportStatusReason = nil
            updateTeleportButton()
        end
    end  

    if checkNoTargets() then
        currentTarget = nil
        trackedTarget = nil
        return
    end
    
    if teleportStatusReason == "No Target" and hasValidTargets() then
        teleportStatusReason = nil
        updateTeleportButton()
    end

    if shared._combatSettings.teleportOn and not manualOff and hasValidTargets() then  
        if not trackedTarget then  
            trackedTarget = selectTarget()  
        end  

        if shared._combatSettings.oneTimeKill and trackedTarget then  
            local thum = trackedTarget.Character and trackedTarget.Character:FindFirstChildOfClass("Humanoid")  
            if not thum or thum.Health <= 0 then  
                if shared._combatSettings.oneTimeKill then
                    shared._combatSettings.teleportOn = false  
                    autoDisabled = true
                    teleportStatusReason = "Target Down"  
                    updateTeleportButton()  
                    currentTarget = nil  
                    trackedTarget = nil  
                    return  
                end
            end  
        end  

        if shared._combatSettings.lockTarget then  
            if trackedTarget and isValidTarget(trackedTarget) then  
                currentTarget = trackedTarget  
            else  
                if not shared._combatSettings.oneTimeKill then  
                    trackedTarget = selectTarget()  
                    currentTarget = trackedTarget  
                end  
            end  
        else  
            if not shared._combatSettings.oneTimeKill then  
                trackedTarget = selectTarget()  
                currentTarget = trackedTarget  
            end  
        end  

        if currentTarget and currentTarget.Character and currentTarget.Character:FindFirstChild("HumanoidRootPart") then
            local myChar = lp.Character
            if myChar and myChar:FindFirstChild("HumanoidRootPart") then  
                local enemyRootPart = currentTarget.Character.HumanoidRootPart
                local distance = shared._combatSettings.teleportDistance
                local upOffset = shared._combatSettings.teleportUp
                local targetPosition = enemyRootPart.Position + Vector3.new(0, upOffset, 0) - (enemyRootPart.CFrame.LookVector * distance)
                
                moveEntireCharacter(myChar, CFrame.new(targetPosition, enemyRootPart.Position))
            end
        end
    end

    if not shared._combatSettings.teleportOn and shared._combatSettings.dodge and dodgePosition then
        local char = lp.Character
        if char and char:FindFirstChild("HumanoidRootPart") then
            local hrp = char.HumanoidRootPart
            moveEntireCharacter(char, CFrame.new(dodgePosition, dodgePosition + hrp.CFrame.LookVector))
            dodgePosition = nil
        end
    end
end)

-- Initialize animation monitoring
task.wait(1)
for _, player in ipairs(Players:GetPlayers()) do
    if player ~= lp then
        monitorPlayerAnimations(player)
    end
end

-- Initialize ignore list UI
updateIgnoreUI()
